# Data Model: Public Gallery Homepage

**Feature**: 004-public-gallery
**Date**: 2025-11-15
**Status**: Complete

## Overview

This document defines the data structures and relationships for the public gallery feature. The gallery displays approved photos using cursor-based pagination.

---

## Entities

### 1. PhotoSubmission (Existing Model - Updates Needed)

**Purpose**: Represents a photo submitted to the contest.

**Location**: `app/Models/PhotoSubmission.php`

**Attributes**:

| Field | Type | Nullable | Description |
|-------|------|----------|-------------|
| `id` | bigint unsigned | No | Primary key |
| `user_id` | bigint unsigned | No | Foreign key to users table (submitter) |
| `image_path` | string | No | Storage path to full-size image |
| `thumbnail_path` | string | Yes | Storage path to thumbnail (generated on upload) |
| `status` | enum | No | Approval status: 'pending', 'approved', 'rejected' |
| `rate` | decimal(3,2) | Yes | Average rating or vote count |
| `created_at` | timestamp | No | Submission timestamp |
| `updated_at` | timestamp | No | Last modification timestamp |

**Indexes**:

| Index Name | Columns | Type | Purpose |
|------------|---------|------|---------|
| PRIMARY | id | Primary | Row identification |
| photo_submissions_user_id_foreign | user_id | Foreign | Relationship lookup |
| photo_submissions_status_created_at_index | status, created_at | Composite | Gallery query optimization |

**Relationships**:
- `belongsTo(User::class)` - Submitter of the photo

**New Methods Needed**:

```php
// Query Scope for approved photos
public function scopeApproved($query)
{
    return $query->where('status', 'approved');
}

// Accessor for thumbnail URL
protected function thumbnailUrl(): Attribute
{
    return Attribute::make(
        get: fn () => $this->thumbnail_path
            ? Storage::url($this->thumbnail_path)
            : Storage::url($this->image_path) // Fallback if no thumbnail
    );
}

// Accessor for full image URL
protected function fullImageUrl(): Attribute
{
    return Attribute::make(
        get: fn () => Storage::url($this->image_path)
    );
}
```

**Validation Rules** (from spec requirements):
- `status` must be one of: 'pending', 'approved', 'rejected'
- `image_path` must exist and be accessible
- `thumbnail_path` should be < 50KB (validated during upload, not in model)

**State Transitions**:
```
pending → approved (admin approval in Issue #2)
pending → rejected (admin rejection in Issue #2)
```

**Gallery Query Pattern**:
```php
PhotoSubmission::query()
    ->approved()
    ->select(['id', 'thumbnail_path', 'image_path', 'rate', 'created_at'])
    ->orderBy('created_at')
    ->cursorPaginate(20);
```

---

### 2. GalleryPage (Conceptual - Not Persisted)

**Purpose**: Represents a paginated batch of photos returned to the frontend.

**Structure** (TypeScript Interface):

```typescript
interface GalleryPage {
  data: Photo[];
  next_cursor: string | null;
  prev_cursor: string | null;
  per_page: number;
  path: string;
}

interface Photo {
  id: number;
  thumbnail_url: string;
  full_image_url: string;
  rate: number | null;
  created_at: string; // ISO 8601 format
}
```

**Properties**:

| Property | Type | Nullable | Description |
|----------|------|----------|-------------|
| `data` | Photo[] | No | Array of photo objects (20 items max) |
| `next_cursor` | string | Yes | Base64-encoded cursor for next page (null if last page) |
| `prev_cursor` | string | Yes | Base64-encoded cursor for previous page (null if first page) |
| `per_page` | number | No | Number of items per page (always 20) |
| `path` | string | No | Base URL path for pagination |

**Generated By**: Laravel's `cursorPaginate(20)->through()` in `PublicGalleryController`

**Consumed By**: React component in `resources/js/Pages/Gallery/Index.tsx`

---

## Database Schema Changes

### Migration Updates Required

**File**: Existing migration `XXXX_create_photo_submissions_table.php`

**Change**: Add composite index if not exists

```php
Schema::table('photo_submissions', function (Blueprint $table) {
    // Add composite index for gallery queries
    $table->index(['status', 'created_at'], 'photo_submissions_status_created_at_index');
});
```

**Verification Query**:
```sql
-- Check if index exists
SHOW INDEXES FROM photo_submissions WHERE Key_name = 'photo_submissions_status_created_at_index';
```

---

## Data Flow

### Gallery Page Load Flow

```
User Request
    ↓
PublicGalleryController::index()
    ↓
PhotoSubmission::approved()
  ->orderBy('created_at')
  ->cursorPaginate(20)
    ↓
Transform to Photo objects
  (id, thumbnail_url, full_image_url, rate, created_at)
    ↓
Inertia::render('Gallery/Index', ['photos' => $photos])
    ↓
React Component (Gallery/Index.tsx)
    ↓
PhotoGrid Component
    ↓
GalleryPhotoCard Components (20x)
```

### Infinite Scroll Flow

```
User scrolls to bottom
    ↓
Intersection Observer triggers
    ↓
router.get('/', { cursor: next_cursor }, { preserveState: true })
    ↓
PublicGalleryController::index() with cursor param
    ↓
PhotoSubmission::approved()
  ->orderBy('created_at')
  ->cursorPaginate(20, ['*'], 'cursor', $request->cursor)
    ↓
Transform to Photo objects
    ↓
Return Inertia response (only 'photos' prop)
    ↓
React merges new photos with existing
  setPhotos(prev => [...prev, ...newPhotos.data])
    ↓
Append new GalleryPhotoCard components to grid
```

---

## Performance Considerations

### Query Optimization

**Index Usage**:
```sql
EXPLAIN SELECT id, thumbnail_path, image_path, rate, created_at
FROM photo_submissions
WHERE status = 'approved'
ORDER BY created_at ASC
LIMIT 20;

-- Expected: Using index 'photo_submissions_status_created_at_index'
-- Type: range (status filter) + index scan (created_at order)
-- Rows: ~20 (LIMIT applied early)
```

**N+1 Prevention**:
- Gallery query selects only needed columns (no lazy loading of relationships)
- No additional queries per photo (user relationship not loaded)
- Single query per pagination request

**Cursor Pagination Benefits**:
- Consistent results even when new photos approved during browsing
- No "page drift" issues (offset pagination problem)
- Efficient for large datasets (no OFFSET calculation overhead)

### Memory Considerations

**Backend**:
- Each pagination request loads 20 records
- Only selected columns loaded (not entire row)
- Memory usage: ~10KB per request (20 photos × 500 bytes avg)

**Frontend**:
- Accumulates photos in React state (grows with scroll)
- 100 photos loaded = ~50KB state (20 photos × 2.5KB avg JSON)
- Acceptable per spec requirement: < 100MB for 100 loaded photos

---

## Data Validation

### Controller-Level Validation

**Query Parameter Validation**:
```php
// In PublicGalleryController
$validated = $request->validate([
    'cursor' => ['nullable', 'string'], // Laravel handles cursor decoding
]);
```

**Response Validation** (automatic via Inertia):
- Photo IDs are integers
- URLs are valid (Storage::url() generates correct paths)
- Timestamps are ISO 8601 formatted

### Model-Level Validation

**Factory Definition** (for testing):
```php
// database/factories/PhotoSubmissionFactory.php
public function definition(): array
{
    return [
        'user_id' => User::factory(),
        'image_path' => 'photos/' . fake()->uuid() . '.jpg',
        'thumbnail_path' => 'photos/thumbnails/' . fake()->uuid() . '.jpg',
        'status' => 'pending',
        'rate' => fake()->randomFloat(2, 0, 5),
    ];
}

public function approved(): static
{
    return $this->state(fn (array $attributes) => [
        'status' => 'approved',
    ]);
}
```

---

## Edge Cases

### Empty Gallery (Zero Approved Photos)

**Behavior**:
- Query returns empty collection
- `next_cursor` is null
- `data` is empty array `[]`
- Frontend displays: "No photos available yet. Check back soon!"

**Query**:
```php
// Returns CursorPaginator with 0 items
PhotoSubmission::approved()->cursorPaginate(20);
// $photos->isEmpty() === true
// $photos->nextCursor() === null
```

### Last Page (Exactly 20 Photos or < 20 Remaining)

**Behavior**:
- If exactly 20 photos remain: `next_cursor` is null after load
- If < 20 photos remain: Returns partial page, `next_cursor` is null
- Frontend displays: "You've reached the end!"

**Example**:
```php
// 55 total approved photos
// Page 1: 20 photos, next_cursor = "cursor_to_page_2"
// Page 2: 20 photos, next_cursor = "cursor_to_page_3"
// Page 3: 15 photos, next_cursor = null (end)
```

### Single Page (1-20 Photos Total)

**Behavior**:
- Initial load returns all photos
- `next_cursor` is null from start
- Infinite scroll never triggers
- No "You've reached the end!" message (implicit - no load trigger)

### Concurrent Approvals During Browsing

**Behavior**:
- Cursor pagination ensures consistent results
- User won't see duplicate photos
- Newly approved photos appear only on page reload
- Acceptable per spec assumption A-009

---

## API Response Examples

### Initial Page Load (First 20 Photos)

```json
{
  "photos": {
    "data": [
      {
        "id": 1,
        "thumbnail_url": "/storage/photos/thumbnails/uuid1.jpg",
        "full_image_url": "/storage/photos/uuid1.jpg",
        "rate": 4.5,
        "created_at": "2025-01-15T10:30:00Z"
      },
      // ... 19 more photos
    ],
    "next_cursor": "eyJpZCI6MjAsImNyZWF0ZWRfYXQiOiIyMDI1LTAxLTE1VDExOjAwOjAwWiJ9",
    "prev_cursor": null,
    "per_page": 20,
    "path": "http://localhost:8000"
  }
}
```

### Subsequent Page (Photos 21-40)

```json
{
  "photos": {
    "data": [
      {
        "id": 21,
        "thumbnail_url": "/storage/photos/thumbnails/uuid21.jpg",
        "full_image_url": "/storage/photos/uuid21.jpg",
        "rate": 3.8,
        "created_at": "2025-01-15T11:05:00Z"
      },
      // ... 19 more photos
    ],
    "next_cursor": "eyJpZCI6NDAsImNyZWF0ZWRfYXQiOiIyMDI1LTAxLTE1VDEyOjAwOjAwWiJ9",
    "prev_cursor": "eyJpZCI6MjAsImNyZWF0ZWRfYXQiOiIyMDI1LTAxLTE1VDExOjAwOjAwWiJ9",
    "per_page": 20,
    "path": "http://localhost:8000"
  }
}
```

### Last Page (Photos 41-50, 10 Remaining)

```json
{
  "photos": {
    "data": [
      {
        "id": 41,
        "thumbnail_url": "/storage/photos/thumbnails/uuid41.jpg",
        "full_image_url": "/storage/photos/uuid41.jpg",
        "rate": 4.2,
        "created_at": "2025-01-15T12:30:00Z"
      },
      // ... 9 more photos (total 10)
    ],
    "next_cursor": null,
    "prev_cursor": "eyJpZCI6NDAsImNyZWF0ZWRfYXQiOiIyMDI1LTAxLTE1VDEyOjAwOjAwWiJ9",
    "per_page": 20,
    "path": "http://localhost:8000"
  }
}
```

### Empty Gallery (Zero Approved Photos)

```json
{
  "photos": {
    "data": [],
    "next_cursor": null,
    "prev_cursor": null,
    "per_page": 20,
    "path": "http://localhost:8000"
  }
}
```

---

## Testing Considerations

### Factory States for Testing

```php
// In tests
PhotoSubmission::factory()->approved()->count(50)->create(); // 50 approved photos
PhotoSubmission::factory()->count(20)->create(); // 20 pending (not in gallery)
PhotoSubmission::factory()->rejected()->count(10)->create(); // 10 rejected (not in gallery)
```

### Test Scenarios

1. **Empty gallery**: 0 approved photos
2. **Single page**: 15 approved photos (< 20)
3. **Exact page**: 20 approved photos (exactly 1 page)
4. **Multiple pages**: 55 approved photos (3 pages: 20, 20, 15)
5. **Large dataset**: 500 approved photos (test performance)
6. **Mixed statuses**: 30 approved, 20 pending, 10 rejected (only 30 in gallery)

---

## Summary

**Entities**: 1 persisted (PhotoSubmission), 1 conceptual (GalleryPage)
**New Methods**: 3 (scopeApproved, thumbnailUrl accessor, fullImageUrl accessor)
**Schema Changes**: 1 composite index on (status, created_at)
**Performance**: Optimized for < 100ms queries, < 10,000 photos
**Edge Cases**: All handled (empty, single page, last page, concurrent updates)

Ready to proceed to API contracts and quickstart documentation.
